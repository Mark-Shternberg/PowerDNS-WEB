@page
@model PowerDNS_Web.Pages.loginModel
@{
}

@if (ViewData["SettingsCheck"]?.ToString() == "False")
{
    <!-- WARNING MESSAGE-->
    <div class="alert alert-warning align-items-center justify-content-center" style="display:flex;" role="alert">
        <i class="fa fa-exclamation-triangle fa-2x me-2"></i>
        <div>
            It seems your settings <strong>is missen</strong>. Run <text class="code-c">powerdnsweb configure</text> in the server to setup settings.
        </div>
    </div>
}
else
{
    <div style="display: flex; justify-content: center; align-items: center;">
        <div class="card p-4 shadow-lg" style="width: 350px;">
            <h3 class="text-center mb-3">Вход</h3>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Логин</label>
                    <input type="text" class="form-control" id="username" placeholder="Введите логин" required>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Пароль</label>
                    <input type="password" class="form-control" id="password" placeholder="Введите пароль" required>
                </div>

                <button type="submit" class="btn btn-primary w-100">Войти</button>
            </form>

            <!-- Уведомление -->
            <div id="notification-div" class="alert mt-3 d-none"></div>
        </div>
    </div>
}

@Html.AntiForgeryToken()

<script>
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
        e.preventDefault(); // Останавливаем отправку формы

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        // Отправка запроса на сервер
        const response = await fetch('/login?handler=Login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                username: username,
                password: password,
            })
        });

        const result = await response.json(); // Делаем парсинг ответа

        const notification = document.getElementById('notification-div');

        if (response.ok && result.success) {
            showLoginNotification('Авторизация успешна! Перенаправление...', 1);
            setTimeout(() => window.location.href = "/index", 1200);
        } else {
            showLoginNotification('Ошибка авторизации. ' + result.message, 2);
        }
    });

    // Функция для отображения уведомлений
    function showLoginNotification(message, type) {
        var notification = document.getElementById("notification-div");
        //var messageSpan = document.getElementById("notification-message");

        notification.innerText = message;

        notification.classList.remove("notification-success", "notification-error");

        if (type === 1) {
            notification.classList.add("notification-success");
        } else if (type === 2) {
            notification.classList.add("notification-error");
        }

        notification.classList.remove('d-none');
        notification.classList.add("show");

        // Скрытие уведомления через 3 секунды
        setTimeout(function () {
            notification.classList.remove("show");
            notification.classList.add('d-none');
        }, 3000);
    }
</script>
