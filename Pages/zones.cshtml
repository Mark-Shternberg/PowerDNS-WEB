@page
@model ZonesModel
@{
    ViewData["Title"] = "Zones";
}

<div class="container py-3">

    <!-- ===== PAGE HEADER / ACTIONS ===== -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
            <h2 class="mb-0"><i class="fa fa-shield-halved me-2"></i>Zones</h2>
            <div class="text-muted small">Authoritative zones management</div>
        </div>
        @if (User.IsInRole("Administrator"))
        {
            <div class="d-flex flex-wrap gap-2">
                <button type="button" onclick="showModal('Forward')" class="btn btn-primary">
                    <i class="fa fa-plus me-1"></i> Add forward zone
                </button>
                <button type="button" onclick="showModal('Reverse')" class="btn btn-outline-primary">
                    <i class="fa fa-plus me-1"></i> Add reverse zone
                </button>
            </div>
        }
    </div>

    <!-- ===== SEARCH ===== -->
    <div class="d-flex justify-content-center mb-3">
        <div class="input-group" style="max-width: 560px;">
            <span class="input-group-text"><i class="fa fa-search"></i></span>
            <input class="form-control" id="search" type="text" placeholder="Search by domain">
            <button type="button" id="clear-btn" onclick="clearSearch()" class="btn btn-default" style="display:none">
                Clear
            </button>
        </div>
    </div>

    <!-- ===== ZONES TABLE ===== -->
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="main_table">
            <thead class="table-dark">
                <tr>
                    <th>Domain</th>
                    <th style="width: 180px;">Master server</th>
                    <th style="width: 150px;">Zone type</th>
                    <th style="width: 220px;">DNSSEC</th>
                    <th style="width: 160px;">Serial</th>
                    <th style="width: 210px;">Actions</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var zone in Model.Zones)
            {
                <tr>
                    <td><a href="/zone/@zone.name" class="text-decoration-none">@zone.name</a></td>
                    <td>@zone.Master</td>
                    <td>
                        @if (zone.kind == "Master")
                        {
                            <i class="fa fa-server text-primary" title="Master Zone"></i> <span>Master</span>
                        }
                        else if (zone.kind == "Slave")
                        {
                            <i class="fa fa-cloud text-secondary" title="Slave Zone"></i> <span>Slave</span>
                        }
                        else if (zone.kind == "Native")
                        {
                            <i class="fa fa-database text-info" title="Native Zone"></i> <span>Native</span>
                        }
                        else
                        {
                            <i class="fa fa-question-circle text-warning" title="Unknown Zone Type"></i> <span>@zone.kind</span>
                        }
                    </td>
                    <td>
                        @if (zone.dnssec)
                        {
                            <div class="d-flex align-items-center gap-2">
                                <i class="fa fa-key text-success" title="DNSSEC Enabled"></i>
                                <span>Enabled</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="dnssecKeys('@zone.name')">
                                    <i class="fa fa-key me-1"></i> Keys
                                </button>
                            </div>
                        }
                        else
                        {
                            <i class="fa fa-ban text-danger" title="DNSSEC Disabled"></i> <span>Disabled</span>
                        }
                    </td>
                    <td>@zone.serial</td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-warning"
                                    onclick="openEditModal('@zone.name', '@zone.kind', '@zone.Master', '@zone.dnssec', '@zone.serial')">
                                <i class="fa fa-edit"></i>
                                Edit
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDelete('@zone.name')">
                                <i class="fa fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<!-- ===== ADD/EDIT ZONE MODAL ===== -->
<div class="modal fade" id="addZoneModal" tabindex="-1" aria-labelledby="addZoneModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addZoneModalLabel">Add Zone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="hideModal()"></button>
            </div>
            <div class="modal-body">

                <!-- FORWARD DOMAIN -->
                <div class="mb-3" id="domain-block">
                    <label for="modal-domain" class="form-label">Zone Name <span class="text-danger">*</span></label>
                    <input type="text" id="modal-domain" class="form-control" placeholder="example.com">
                </div>

                <!-- REVERSE DOMAIN -->
                <div class="mb-3 d-none" id="reverse-block">
                    <label for="modal-reverse" class="form-label">Reverse prefix <span class="text-danger">*</span></label>
                    <input type="text" id="modal-reverse" class="form-control" placeholder="192.168.0.">
                    <div class="form-text">Network prefix (no last octet). Example: <code>192.168.0.</code></div>
                </div>

                <div class="row g-3">
                    <div class="col-sm-6">
                        <label for="modal-type" class="form-label">Zone type <span class="text-danger">*</span></label>
                        <select id="modal-type" class="form-select" onchange="ZoneToggle()">
                            <option value="Native">Native</option>
                            <option value="Master">Master</option>
                            <option value="Slave">Slave</option>
                        </select>
                    </div>
                    <div class="col-sm-6">
                        <label for="modal-dnssec" class="form-label">DNSSEC <span class="text-danger">*</span></label>
                        <select id="modal-dnssec" class="form-select">
                            <option value="Enabled">Enabled</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                    </div>
                </div>

                <div id="slave-div" class="mt-3 d-none">
                    <label for="modal-mserver" class="form-label">Master server <span class="text-danger">*</span></label>
                    <input class="form-control ip-input" id="modal-mserver" type="text" placeholder="1.2.3.4">
                </div>

            </div>
            <div class="modal-footer">
                <!-- UPDATE BUTTONS -->
                <div id="update-buttons" class="d-none">
                    <button type="button" id="btn-cancel" class="btn btn-default me-2" onclick="hideModal()">Cancel</button>
                    <button type="button" id="btn-save" class="btn btn-save" onclick="save()">Save</button>
                </div>
                <!-- CREATE BUTTONS -->
                <div id="create-buttons">
                    <button type="button" class="btn btn-secondary me-2" onclick="hideModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addZone()">Add</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== CONFIRM DELETE (CUSTOM MODAL, NO BACKDROP) ===== -->
<div id="confirmModal" class="modal" style="display:none">
    <div class="modal-content">
        <p id="confirmMessage" class="mb-2"></p>
        <div class="modal-buttons">
            <button id="confirmNo" class="btn btn-default">Cancel</button>
            <button id="confirmYes" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<!-- ===== DNSSEC KEYS MODAL ===== -->
<div class="modal fade" id="dnssecKeysModal" tabindex="-1" aria-labelledby="dnssecKeysModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="dnssecKeysModalLabel">
                    <i class="fa fa-key me-2"></i> DNSSEC Keys
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="hideDnssecModal()"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="fa fa-exclamation-triangle fa-lg me-2"></i>
                    <div>The DS records below <strong>must</strong> be provided to your domain registrar.</div>
                </div>
                <div id="dsRecordsContainer" class="vstack gap-2"></div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- PAGE-SPECIFIC LOGIC -->
@section Scripts {
<script src="~/js/zone.js"></script>
<script src="~/js/validation.js"></script>
<script>
    // ===== SEARCH WIRING =====
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search");
        const clearButton = document.getElementById("clear-btn");

        const filterTable = () => {
            const filter = (searchInput.value || "").toLowerCase();
            const rows = document.querySelectorAll("#main_table tbody tr");
            rows.forEach(r => {
                const domainCell = r.querySelector("td:first-child");
                const txt = (domainCell?.textContent || "").trim().toLowerCase();
                r.style.display = txt.includes(filter) ? "" : "none";
            });
        };
        const toggleClearButton = () => { clearButton.style.display = searchInput.value.length > 0 ? "inline-block" : "none"; };

        searchInput.addEventListener("input", () => { toggleClearButton(); filterTable(); });
        window.clearSearch = () => { searchInput.value = ""; filterTable(); toggleClearButton(); };
    });
</script>
}
